<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>Evalica Wasm</title>
    <style>
        body {
            font-family: sans-serif;
            margin: 2em;
            line-height: 1.5;
        }

        pre {
            background: #f4f4f4;
            padding: 1em;
            overflow-x: auto;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>Evalica Wasm</h1>
    <p>This is a minimal working example of <a href="https://github.com/dustalov/evalica">Evalica</a> running in the
        browser via WebAssembly.</p>

    <h2>Pairwise Comparison Input Data</h2>
    <pre id="input-data">| **Item X** | **Item Y** | **Winner** |
| `pizza`    | `burger`   | `x`        |
| `burger`   | `sushi`    | `y`        |
| `pizza`    | `sushi`    | `tie`      |</pre>

    <h2>Pairwise Method Selection</h2>
    <select id="method-select">
        <option value="counting">Counting</option>
        <option value="average_win_rate">Average Win Rate</option>
        <option value="bradley_terry">Bradley&ndash;Terry</option>
        <option value="newman">Newman</option>
        <option value="eigen">Eigenvalue</option>
        <option value="pagerank">PageRank</option>
        <option value="elo">Elo</option>
    </select>
    <button id="run-button">Run</button>

    <h2 id="method-title">Results</h2>
    <div id="status">Loading Wasm...</div>
    <pre id="output"></pre>

    <h2>Krippendorff's Alpha Input Data</h2>
    <pre id="alpha-input-data">Raters rating 4 units:
Unit 1: [1, 1, None, 1]
Unit 2: [2, 2, 3, 2]
Unit 3: [3, 3, 3, 3]
Unit 4: [3, 3, 3, 3]</pre>

    <h2>Distance Metric</h2>
    <select id="distance-select">
        <option value="nominal">Nominal</option>
        <option value="ordinal">Ordinal</option>
        <option value="interval">Interval</option>
        <option value="ratio">Ratio</option>
    </select>
    <button id="alpha-button">Run Alpha</button>

    <h2 id="alpha-title">Alpha Results</h2>
    <div id="alpha-status"></div>
    <pre id="alpha-output"></pre>
</div>

<script type="module">
    import init, {
        counting,
        averageWinRate,
        bradleyTerry,
        newman,
        eigen,
        pagerank,
        elo,
        alpha
    } from './pkg/evalica.js';

    async function run() {
        try {
            await init();
            document.getElementById('status').innerText = 'Wasm loaded. Ready.';

            // Example data from README.md
            const items = ['pizza', 'burger', 'sushi'];
            const xs = new Uint32Array([0, 1, 0]);
            const ys = new Uint32Array([1, 2, 2]);
            const winners = new Uint8Array([1, 2, 0]); // 1=X, 2=Y, 0=Draw
            const weights = new Float64Array([1.0, 1.0, 1.0]);
            const total = items.length;

            const runMethod = () => {
                const method = document.getElementById('method-select').value;
                document.getElementById('status').innerText = `Running ${method}...`;
                document.getElementById('method-title').innerText = `Results: ${method}`;

                let results;
                const win_weight = 1.0;
                const tie_weight = 0.5;

                try {
                    switch (method) {
                        case 'counting':
                            results = counting(xs, ys, winners, weights, total, win_weight, tie_weight);
                            break;
                        case 'average_win_rate':
                            results = averageWinRate(xs, ys, winners, weights, total, win_weight, tie_weight);
                            break;
                        case 'bradley_terry':
                            results = bradleyTerry(xs, ys, winners, weights, total, win_weight, tie_weight, 1e-6, 100);
                            break;
                        case 'newman':
                            results = newman(xs, ys, winners, weights, total, 1.0, 1e-6, 100);
                            break;
                        case 'eigen':
                            results = eigen(xs, ys, winners, weights, total, win_weight, tie_weight, 1e-6, 100);
                            break;
                        case 'pagerank':
                            results = pagerank(xs, ys, winners, weights, total, win_weight, tie_weight, 0.85, 1e-6, 100);
                            break;
                        case 'elo':
                            results = elo(xs, ys, winners, weights, total, 1000.0, 10.0, 400.0, 32.0, win_weight, tie_weight);
                            break;
                    }

                    const scores = Array.from(results);
                    let outputText = 'Item scores:\n';
                    items.forEach((item, i) => {
                        outputText += `${item}: ${scores[i].toFixed(4)}\n`;
                    });

                    document.getElementById('output').innerText = outputText;
                    document.getElementById('status').innerText = 'Done!';
                } catch (err) {
                    document.getElementById('status').innerText = 'Error: ' + err;
                    console.error(err);
                }
            };

            const runAlpha = () => {
                const distance = document.getElementById('distance-select').value;
                document.getElementById('alpha-status').innerText = `Running Krippendorff's alpha with ${distance} distance...`;
                document.getElementById('alpha-title').innerText = `Alpha Results: ${distance}`;

                try {
                    // Simplified example data (4 units, 4 raters)
                    // Unit 1: [1, 1, None, 1]  -> codes: [0, 0, -1, 0]
                    // Unit 2: [2, 2, 3, 2]     -> codes: [1, 1, 2, 1]
                    // Unit 3: [3, 3, 3, 3]     -> codes: [2, 2, 2, 2]
                    // Unit 4: [3, 3, 3, 3]     -> codes: [2, 2, 2, 2]
                    // Unique values: [1, 2, 3]
                    const codes = new BigInt64Array([
                        0n, 0n, -1n, 0n,   // Unit 1
                        1n, 1n, 2n, 1n,    // Unit 2
                        2n, 2n, 2n, 2n,    // Unit 3
                        2n, 2n, 2n, 2n     // Unit 4
                    ]);
                    const uniqueValues = new Float64Array([1.0, 2.0, 3.0]);
                    const nUnits = 4;
                    const nRaters = 4;

                    const results = alpha(codes, uniqueValues, nUnits, nRaters, distance);
                    const [alphaValue, observed, expected] = Array.from(results);

                    let outputText = `Krippendorff's alpha: ${alphaValue.toFixed(6)}\n`;
                    outputText += `Observed disagreement: ${observed.toFixed(6)}\n`;
                    outputText += `Expected disagreement: ${expected.toFixed(6)}\n`;

                    document.getElementById('alpha-output').innerText = outputText;
                    document.getElementById('alpha-status').innerText = 'Done!';
                } catch (err) {
                    document.getElementById('alpha-status').innerText = 'Error: ' + err;
                    console.error(err);
                }
            };

            document.getElementById('run-button').onclick = runMethod;
            document.getElementById('alpha-button').onclick = runAlpha;
            runMethod();
        } catch (e) {
            document.getElementById('status').innerText = 'Error: ' + e;
            console.error(e);
        }
    }

    run();
</script>
</body>
</html>
